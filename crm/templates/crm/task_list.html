{% extends 'crm/base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3><i class="bi bi-list-task me-2"></i>Task List</h3>
    {% if request.session.role in 'admin sales' %}
    <a href="{% url 'add_task' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-2"></i>Add Task
    </a>
    {% endif %}
</div>

<div class="mb-3">
    <input type="text" id="searchInput" class="form-control" placeholder="Search tasks...">
</div>

{% if tasks %}
<div class="table-responsive">
    <table class="table table-striped table-hover table-bordered" id="taskTable">
        <thead class="table-dark">
            <tr>
                <th>Title</th>
                <th>Description</th>
                <th>Client</th>
                <th>Assigned To</th>
                <th>Assigned By</th>
                <th>Due Date</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.title }}</td>
                <td>{{ task.description|truncatechars:50 }}</td>
                <td>{{ task.client.name }}</td>
                <td>{{ task.assigned_to.username }}</td>
                <td>{{ task.assigned_by.username }}</td>
                <td>{{ task.due_date|date:"M d, Y" }}</td>
                <td>
                    <span class="badge bg-{% if task.status == 'completed' %}success{% else %}warning{% endif %}">
                        {{ task.status|title }}
                    </span>
                </td>
<td>
    {% if request.session.role in 'support admin' or request.session.user_id == task.assigned_to.id %}
    <form method="post" action="{% url 'toggle_task_status' task.id %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-{% if task.status == 'pending' %}success{% else %}secondary{% endif %}">
            {% if task.status == 'pending' %}Mark Complete{% else %}Reopen{% endif %}
        </button>
    </form>
    {% endif %}
    {% if request.session.role == 'support' and request.session.user_id == task.assigned_to.id %}
    <a href="https://mail.google.com/mail/?view=cm&fs=1&to={{ task.assigned_by.email }}&su=Task: {{ task.title }}&body=Hello {{ task.assigned_by.username }},%0D%0A%0D%0AI have a question about the task titled '{{ task.title }}'." target="_blank" class="btn btn-sm btn-outline-primary ms-1">
        <i class="bi bi-envelope"></i> Send Email
    </a>
    {% endif %}
    {% if user_role in 'admin sales' %}
    <a href="{% url 'edit_task' task.id %}" class="btn btn-sm btn-warning ms-1">Edit</a>
    <form method="post" action="{% url 'delete_task' task.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-danger ms-1" onclick="return confirm('Are you sure you want to delete this task?');">
            Delete
        </button>
    </form>
    {% endif %}
</td>

            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
    <div class="alert alert-info text-center" role="alert">
        <i class="bi bi-info-circle-fill me-2"></i>No tasks found.
    </div>
{% endif %}

<script>
function searchTasks() {
    var input, filter, table, tr, td, i, j, txtValue;
    input = document.getElementById("searchInput");
    filter = input.value.toUpperCase();
    table = document.getElementById("taskTable");
    tr = table.getElementsByTagName("tr");

    for (i = 1; i < tr.length; i++) { // Start from 1 to skip the header row
        var display = "none";
        td = tr[i].getElementsByTagName("td");
        for (j = 0; j < td.length; j++) {
            if (td[j]) {
                txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    display = "";
                    break;
                }
            }
        }
        tr[i].style.display = display;
    }
}

document.getElementById("searchInput").addEventListener("keyup", searchTasks);
</script>

{% endblock %}